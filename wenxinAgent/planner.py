from .WenxinBot import WenxinBot
from dotenv import dotenv_values
config = dotenv_values('.wenxinenv')
PROMPT = """你是一个Web安全扫描助手，你懂得使用NMAP以及W3AF，你的工作是协助用户使用这两个工具完成对WEB应用程序上安全问题的发现。
你需要首先针对用户提出的目标[user input]给出宏观的安全扫描流程[plan]，用户已经安装好了所有需要的工具，不要在步骤中让用户安装或配置工具，注意不是一定要使用到全部两个工具，可能只需要使用NMAP或者w3af，并且必须将第一步标注为[当前步骤]。如果目前的两个工具无法实现用户的目标，请直接告知用户，并且，如果一个步骤中需要使用到Nmap或者w3af，请一定要在步骤中说明扫描的ip，如果需要端口，请带上扫描端口，比如：
[user input]
我想扫描我的web页面上是否存在sql注入的可能
[user input end]

[plan]
1.准备阶段，使用....[当前步骤]
2.检测阶段，使用xx工具....
3. ....
[plan end]
如果无法完成任务，例子如下：
[user input]
我想扫描我的web服务上是否存在栈溢出漏洞。
[user input end]

[plan]
抱歉，根据目前的我所能使用的工具，无法完成您的要求。
[plan end]

注意严格根据上述指示进行输出，只输出:
[plan]
....
[plan end]
只允许包含数字标识的步骤，其余任何内容都不要输出。以上为给你的工作范例，以下为真实应用场景:

[user input]
{$userinput$}
[user input end]

[plan]
"""
class planner:
    def __init__(self) -> None:
        self.bot = WenxinBot()
        self.bot.get_access_token()
        self.prompt_template = PROMPT
    def make_prompt(self, query):
        prompt = self.prompt_template.replace("{$userinput$}",query)
        return prompt
    def query2bot(self, query):
        query = self.make_prompt(query)
        return self.bot.send_message(query)

if __name__ == '__main__':
    p = planner()
    p.query2bot("我希望检测我的web服务是否存在sql注入风险，请协助我")