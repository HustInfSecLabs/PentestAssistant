/**
 * 初始化数据库，用户对应的密码是用户名后加123
 */
const path = require('path');
const mongoose = require('mongoose');
const { ScanProfile, Vuln } = require(path.resolve(__dirname, 'db'));
const CWEC_DICT = require(path.resolve(__dirname, 'cwec_v4.12.chinese.json'));

const initDefaultScanProfile = async () => {
  const scanProfile = new ScanProfile({
    name: '默认配置',
    isDefault: true
  });
  const res = await scanProfile.save();
  console.log(res);
};

const initVuln = async () => {
  for (const vuln of CWEC_DICT) {
    const mitigation_formatted = [];

    for (const mitigation of vuln.Potential_Mitigations_ZH.Mitigation) {
      mitigation_formatted.push({
        phase: mitigation.Phase_Merged,
        strategy: mitigation.Strategy_Merged,
        suggestion: mitigation.Description_Merged
      });
    }

    const vulnDoc = new Vuln({
      cwe: vuln.ID,
      name: vuln.Name_ZH ?? '暂无名称',
      level: vuln.Likelihood_Of_Exploit === '' ? 'unknown' : vuln.Likelihood_Of_Exploit.toLowerCase(),
      description: vuln.Description_ZH ?? '暂无描述',
      mitigation: mitigation_formatted
    });
    const res = await vulnDoc.save();
    console.log(vulnDoc);
  }
};

(async () => {
  await mongoose.connect('mongodb://pentest:pentest@127.0.0.1/pentest?authSource=admin');
  await initDefaultScanProfile();
  await initVuln();
  console.log('初始化数据库完成');
  process.exit(0);
})();
